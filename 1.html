<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-19BLJQLP2E"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-19BLJQLP2E');
    </script>

    <meta charset="UTF-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Â§çÂè§Áõ∏Êú∫Ê®°ÊãüÂô®</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
          content="Take instant polaroid photos with your camera! Drag, arrange, and create beautiful collages with this interactive retro camera experience."/>
    <meta name="keywords"
          content="retro camera, polaroid, instant camera, photo collage, interactive camera, web camera, photography"/>
    <meta name="author" content="Bubbbly, Hackflow imporoved"/>

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image"/>
    <meta property="twitter:url" content="https://photo.hackflow.com.cn"/>
    <meta property="twitter:title" content="Retro Camera - Interactive Polaroid Photo Experience"/>
    <meta property="twitter:description"
          content="Take instant polaroid photos with your camera! Drag, arrange, and create beautiful collages with this interactive retro camera experience."/>
    <meta
            property="twitter:image"
            content="https://photo.hackflow.com.cn"
    />

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/retro-camera.webp"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"/>
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png"/>
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"/>

    <!-- Theme Colors -->
    <meta name="theme-color" content="#d4d4d4"/>
    <meta name="msapplication-TileColor" content="#d4d4d4"/>
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png"/>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json"/>

    <!-- Canonical URL -->
    <link rel="canonical" href="https://photo.hackflow.com.cn"/>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #d4d4d4;
            background-image: radial-gradient(#e0e0e0 15%, transparent 16%),
            radial-gradient(#e0e0e0 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            height: 100vh;
            width: 100vw;
            font-family: sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            user-select: none;
            touch-action: none;
        }

        .camera-zone {
            flex: 0 0 50%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            position: relative;
            z-index: 20;
            padding: 20px;
            padding-bottom: 80px;
        }

        .camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1 / 1;
        }

        .camera-img {
            width: 100%;
            height: auto;
            position: relative;
            z-index: 20;
            pointer-events: none;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.4));
        }

        .lens-wrapper {
            position: absolute;
            bottom: 33%;
            left: 62%;
            transform: translateX(-50%);
            width: 26%;
            height: 26%;
            border-radius: 50%;
            overflow: hidden;
            z-index: 25;
            background: #000;
            box-shadow: inset 0 0 15px #000;
        }

        video#cam-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.9;
        }

        .lens-shine {
            position: absolute;
            top: 15%;
            left: 15%;
            width: 30%;
            height: 20%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(-45deg);
            filter: blur(3px);
            z-index: 26;
            pointer-events: none;
        }

        .shutter-btn {
            position: absolute;
            bottom: 42%;
            left: 18%;
            width: 11%;
            height: 11%;
            border-radius: 50%;
            z-index: 30;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .ejection-slot {
            position: absolute;
            z-index: 15;
            top: -40%;
            left: 50%;
            transform: translateX(-50%);
            width: 35%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 20%;
        }

        .desk-zone {
            flex: 1;
            position: relative;
            height: 100%;
        }

        /* --- Buttons --- */
        .btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 200;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #d93025;
            color: #d93025;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Permanent Marker', cursive;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #d93025;
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* Specific style for download to look slightly different or same */
        #download-btn {
            border-color: #222;
            color: #222;
        }

        #download-btn:hover {
            background: #222;
            color: white;
        }

        /* --- Polaroid Styling --- */
        .polaroid {
            width: 170px;
            background: #fdfdfd;
            padding: 10px 10px 55px 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: absolute;
            cursor: grab;
            pointer-events: auto;
            transform-origin: center center;
            touch-action: none;
            transition: opacity 0.5s ease-out, transform 0.2s;
        }

        .polaroid:active {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            z-index: 10000 !important;
        }

        .polaroid img {
            width: 100%;
            height: 170px;
            object-fit: cover;
            background: #222;
            border: 1px solid #e0e0e0;
            pointer-events: none;
            display: block;
            filter: blur(0) grayscale(0) brightness(1);
            will-change: filter;
        }

        .polaroid.developing-start img {
            filter: blur(15px) grayscale(0.5) brightness(0.9);
        }

        .polaroid.developing-slow img {
            transition: filter 6s ease-in-out;
            filter: blur(0) grayscale(0) brightness(1);
        }

        .polaroid.developing-fast img {
            transition: filter 3s ease-out !important;
            filter: blur(0) grayscale(0) brightness(1);
        }

        .polaroid .caption-main {
            position: absolute;
            bottom: 22px;
            left: 10px;
            width: 150px;
            text-align: center;
            color: #222;
            opacity: 0.9;
            cursor: text;
            font-family: 'Permanent Marker', cursive;
            font-size: 14px;
            line-height: 1.1;
            min-height: 18px;
        }

        .polaroid .caption-main:empty::before {
            content: 'May I meet you';
            opacity: 0.5;
        }

        .polaroid .caption-date {
            position: absolute;
            bottom: 8px;
            left: 10px;
            width: 150px;
            text-align: center;
            font-family: 'Permanent Marker', cursive;
            font-size: 10px;
            color: #555;
            pointer-events: none;
            user-select: none;
        }

        .polaroid.ejecting {
            transform: translateY(100%);
            animation: riseOut 2s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes riseOut {
            0% {
                transform: translateY(100%);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 1;
            }
        }

        /* --- Polaroid Controls --- */
        .polaroid-controls {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 50;
            opacity: 0;
            transition: opacity 1s ease-out, transform 0.2s ease-out;
            pointer-events: auto;
        }

        .polaroid:hover .polaroid-controls {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
        }

        .polaroid-btn {
            background: rgba(217, 48, 37, 0.95);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            font-family: 'Permanent Marker', cursive;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            white-space: nowrap;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .polaroid-btn:hover {
            background: rgba(185, 45, 32, 0.95);
            transform: scale(1.05);
        }

        .polaroid-btn:active {
            transform: scale(0.95);
        }

        .delete-btn {
            background: rgba(217, 48, 37, 0.95);
        }

        .delete-btn:hover {
            background: rgba(185, 45, 32, 0.95);
        }

        .zoom-in-btn {
            background: rgba(46, 179, 79, 0.95);
        }

        .zoom-in-btn:hover {
            background: rgba(34, 150, 68, 0.95);
        }

        .zoom-out-btn {
            background: rgba(33, 150, 243, 0.95);
        }

        .zoom-out-btn:hover {
            background: rgba(24, 120, 200, 0.95);
        }

        /* Mobile: show controls on tap, not always visible */
        @media (max-width: 768px), (hover: none) {
            .polaroid .polaroid-controls {
                opacity: 0;
                pointer-events: auto;
                transition: opacity 0.3s ease;
            }

            .polaroid.tapped .polaroid-controls,
            .polaroid:active .polaroid-controls {
                opacity: 1;
                transform: translateX(-50%) translateY(-2px);
            }
        }

        .flash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 10000;
            transition: opacity 0.1s;
        }

        .flash-active {
            opacity: 1;
        }

        /* --- Bottom Navigation Container --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 150;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            pointer-events: none;
        }

        .bottom-nav > * {
            pointer-events: auto;
        }

        /* --- Shared Pin Board --- */
        .pin-board {
            position: relative;
            background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
            border: 3px solid #6b5d47;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            text-decoration: none;
        }

        .pin-board:hover {
            background: linear-gradient(135deg, #9d8568 0%, #b5957a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }

        .pin-board-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #fff;
            font-family: 'Permanent Marker', cursive;
            font-size: 13px;
            padding: 12px 18px;
            position: relative;
            pointer-events: none;
            white-space: nowrap;
        }

        .pin-board-content::before {
            content: 'üìå';
            font-size: 18px;
            line-height: 1;
        }

        /* --- Pin Board Modal --- */
        .pin-board-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .pin-board-modal.open {
            display: flex;
        }

        .pin-board-modal-content {
            background: radial-gradient(circle at 20% 30%, rgba(139, 115, 85, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, rgba(139, 115, 85, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(139, 115, 85, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 60% 20%, rgba(139, 115, 85, 0.08) 0%, transparent 50%),
            linear-gradient(135deg, #c9a961 0%, #b8955a 25%, #a8824f 50%, #b8955a 75%, #c9a961 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
            border-radius: 20px;
            padding: 40px;
            max-width: 95%;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
            inset 0 0 100px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 8px solid #8b7355;
        }

        .pin-board-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 2px, rgba(0, 0, 0, 0.03) 4px),
            repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 2px, rgba(0, 0, 0, 0.03) 4px);
            pointer-events: none;
            border-radius: 12px;
        }

        .pin-board-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #8b7355;
            position: relative;
            z-index: 1;
        }

        .pin-board-modal-title {
            font-family: 'Permanent Marker', cursive;
            font-size: 28px;
            color: #fff;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .pin-board-modal-close {
            background: #d93025;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-family: sans-serif;
            line-height: 1;
        }

        .pin-board-modal-close:hover {
            background: #b52d20;
            transform: scale(1.1);
        }

        .pin-board-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            align-content: flex-start;
            justify-content: flex-start;
        }

        .pin-board-gallery-item {
            position: relative;
            width: 200px;
            background: #fdfdfd;
            padding: 10px 10px 55px 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, z-index 0.2s;
            transform-origin: center center;
            flex-shrink: 0;
        }

        .pin-board-gallery-item:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(0, 0, 0, 0.15);
            z-index: 100 !important;
        }

        .pin-board-gallery-item .photo-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            background: #222;
            border: 1px solid #e0e0e0;
        }

        .pin-board-gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .pin-board-gallery-item::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #d63031);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3),
            inset 0 1px 2px rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .pin-board-gallery-item::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 9;
        }

        .pin-board-gallery-item .photo-caption {
            position: absolute;
            bottom: 8px;
            left: 10px;
            right: 10px;
            text-align: center;
            font-family: 'Permanent Marker', cursive;
            color: #222;
            opacity: 0.9;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pin-board-gallery-item .photo-caption-main {
            font-size: 14px;
            line-height: 1.1;
        }

        .pin-board-gallery-item .photo-caption-date {
            font-size: 10px;
            color: #555;
            margin-top: 2px;
        }

        .pin-board-gallery-loading {
            text-align: center;
            padding: 40px;
            font-family: 'Permanent Marker', cursive;
            font-size: 20px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1;
        }

        .pin-board-gallery-empty {
            text-align: center;
            padding: 60px 20px;
            font-family: 'Permanent Marker', cursive;
            font-size: 24px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1;
        }

        .pin-board-gallery-empty::before {
            content: 'üì∑';
            display: block;
            font-size: 64px;
            margin-bottom: 20px;
        }


        /* --- Once Link --- */
        .once-link {
            position: relative;
            text-align: right;
            font-family: 'Permanent Marker', cursive;
            font-size: 13px;
            line-height: 1.3;
            color: #555;
            text-decoration: none;
            transition: color 0.2s;
            max-width: 300px;
            flex-shrink: 1;
        }

        .once-link:hover {
            color: #d93025;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .camera-zone {
                flex: 0 0 auto;
                width: 100%;
                height: auto;
                padding-top: 60px;
                padding-bottom: 40px;
                justify-content: center;
            }

            .desk-zone {
                width: 100%;
                height: 100%;
            }

            .btn-container {
                top: 10px;
                right: 10px;
            }

            .action-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .bottom-nav {
                bottom: 10px;
                left: 10px;
                right: 10px;
                gap: 10px;
            }

            .once-link {
                font-size: 9px;
                max-width: 140px;
                line-height: 1.2;
            }

            .pin-board-content {
                font-size: 11px;
                padding: 10px 14px;
                gap: 6px;
            }

            .pin-board-content::before {
                font-size: 16px;
            }

            .pin-board-modal-content {
                padding: 20px;
                max-width: 95%;
            }

            .pin-board-modal-title {
                font-size: 22px;
            }

            .pin-board-gallery {
                gap: 15px;
                padding: 15px;
            }

            .pin-board-gallery-item {
                width: 150px;
            }

            .polaroid-share-btn {
                font-size: 10px;
                padding: 6px 10px;
                top: -12px;
            }
        }

        /* --- Footer Declaration --- */
        .footer-declaration {
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            font-family: 'Permanent Marker', cursive;
            font-size: 12px;
            color: #666;
            z-index: 100;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
<div class="btn-container">
    <button
            class="action-btn"
            id="download-btn"
            title="Download Collage"
    >
        DOWNLOAD
    </button>
    <button
            class="action-btn"
            id="reset-btn"
            title="Clear all photos"
    >
        RESET
    </button>
</div>

<div class="camera-zone">
    <div class="camera-wrapper">
        <div
                class="ejection-slot"
                id="slot"
        ></div>
        <div class="lens-wrapper">
            <video
                    id="cam-feed"
                    autoplay
                    playsinline
                    muted
            ></video>
            <div class="lens-shine"></div>
        </div>
        <img
                src="/assets/retro-camera.webp"
                class="camera-img"
                alt="Retro Camera"
        />
        <div
                class="shutter-btn"
                id="shutter"
        ></div>
    </div>
</div>

<div
        class="desk-zone"
        id="desk"
></div>

<div
        class="flash"
        id="flash"
></div>
<canvas
        id="canvas"
        style="display: none"
></canvas>


<script>
    const video = document.getElementById('cam-feed');
    const canvas = document.getElementById('canvas');
    const shutter = document.getElementById('shutter');
    const slot = document.getElementById('slot');
    const flash = document.getElementById('flash');
    const desk = document.getElementById('desk');
    const resetBtn = document.getElementById('reset-btn');
    const downloadBtn = document.getElementById('download-btn');
    const cameraZone = document.querySelector('.camera-zone');
    const btnContainer = document.querySelector('.btn-container');

    const printSound = new Audio(
        'assets/polaroid-camera.mp3'
    );
    printSound.volume = 0.6;

    let demosCleared = false;

    navigator.mediaDevices
        .getUserMedia({
            video: {facingMode: 'user', width: 480, height: 480},
        })
        .then((stream) => (video.srcObject = stream))
        .catch((err) => console.error(err));

    function getTodayDateString() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}/${mm}/${dd}`;
    }

    const demoDate = getTodayDateString();
    const demos = [
        {
            src: '/assets/pic1.png',
            rot: '-5deg',
            top: '30%',
            left: '30%',
        },
        {
            src: '/assets/pic2.png',
            rot: '8deg',
            top: '35%',
            left: '45%',
        },
        {
            src: '/assets/pic3.png',
            rot: '-12deg',
            top: '45%',
            left: '35%',
        },
    ];

    function spawnDemos() {
        desk.innerHTML = '';
        demosCleared = false;
        demos.forEach((d) => {
            createPolaroidElement(
                d.src,
                demoDate,
                d.top,
                d.left,
                d.rot,
                true,
                false
            );
        });
    }

    spawnDemos();

    function createPolaroidElement(
        imgSrc,
        dateStr,
        top,
        left,
        rot,
        isDemo = false,
        isNew = false
    ) {
        const div = document.createElement('div');
        div.className = isDemo ? 'polaroid demo-polaroid' : 'polaroid';

        if (isNew) {
            div.classList.add('developing-start');
        }

        div.innerHTML = `
                <img src="${imgSrc}">
                <div class="polaroid-controls">
                    <button class="polaroid-btn delete-btn">üóëÔ∏è Delete</button>
                    <button class="polaroid-btn zoom-in-btn">‚ûï Zoom In</button>
                    <button class="polaroid-btn zoom-out-btn">‚ûñ Zoom Out</button>
                </div>
                <div class="caption-main" contenteditable="true" spellcheck="false">May I meet you</div>
                <div class="caption-date">${dateStr}</div>
            `;

        if (top) div.style.top = top;
        if (left) div.style.left = left;
        if (rot) div.style.transform = `rotate(${rot})`;

        if (isDemo) {
            desk.appendChild(div);
        } else if (isNew) {
            requestAnimationFrame(() => {
                div.offsetWidth;
                div.classList.add('developing-slow');
                div.classList.remove('developing-start');
            });
        }

        // Add control button functionality
        const deleteBtn = div.querySelector('.delete-btn');
        const zoomInBtn = div.querySelector('.zoom-in-btn');
        const zoomOutBtn = div.querySelector('.zoom-out-btn');

        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            deletePolaroid(div);
        });

        zoomInBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            zoomPolaroid(div, 1.2);
        });

        zoomOutBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            zoomPolaroid(div, 0.8);
        });

        // Limit caption text to 30 characters
        const captionMain = div.querySelector('.caption-main');
        if (captionMain) {
            captionMain.addEventListener('input', function () {
                const text = this.textContent;
                if (text.length > 30) {
                    // Trim to 30 characters
                    this.textContent = text.substring(0, 30);
                    // Move cursor to end
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(this);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });

            // Prevent line breaks in caption
            captionMain.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
        }

        // Add tap/touch event for mobile controls
        div.addEventListener('click', function (e) {
            // Don't show controls if clicking on buttons or caption
            if (e.target.closest('.polaroid-btn') || e.target.closest('.caption-main')) {
                return;
            }

            // Toggle tapped class to show/hide controls
            if (!div.classList.contains('tapped')) {
                div.classList.add('tapped');

                // Auto-hide controls after 3 seconds if not interacting with buttons
                setTimeout(() => {
                    if (!div.classList.contains('hovered') && !div.querySelector('.polaroid-controls:hover')) {
                        div.classList.remove('tapped');
                    }
                }, 3000);
            }
        });

        // Handle hover state for auto-hide logic
        div.addEventListener('mouseenter', function () {
            div.classList.add('hovered');
        });

        div.addEventListener('mouseleave', function () {
            div.classList.remove('hovered');
            // Remove tapped class after a short delay if not hovering controls
            setTimeout(() => {
                if (!div.querySelector('.polaroid-controls:hover')) {
                    div.classList.remove('tapped');
                }
            }, 1000);
        });

        // Keep controls visible when hovering over them
        const controls = div.querySelector('.polaroid-controls');
        if (controls) {
            controls.addEventListener('mouseenter', function () {
                div.classList.add('hovered');
            });

            controls.addEventListener('mouseleave', function () {
                div.classList.remove('hovered');
                setTimeout(() => {
                    if (!div.classList.contains('hovered')) {
                        div.classList.remove('tapped');
                    }
                }, 500);
            });
        }

        makeDraggable(div);
        return div;
    }

    function clearDemos() {
        const demoItems = document.querySelectorAll('.demo-polaroid');
        demoItems.forEach((item) => {
            item.style.opacity = '0';
            item.style.transform = 'scale(0.8)';
            setTimeout(() => item.remove(), 500);
        });
        return true;
    }

    resetBtn.addEventListener('click', () => {
        document.querySelectorAll('.polaroid').forEach((p) => p.remove());
        demosCleared = false;
        desk.innerHTML = '';
        slot.innerHTML = '';
        spawnDemos();
    });

    // --- Download Logic ---
    downloadBtn.addEventListener('click', () => {
        // 1. Hide UI elements we don't want in the screenshot
        cameraZone.style.display = 'none';
        btnContainer.style.display = 'none';

        // 2. Use html2canvas to screenshot the body (which contains background + photos)
        html2canvas(document.body, {
            backgroundColor: '#d4d4d4', // Ensure background color is captured
            useCORS: true, // Attempt to load external images (demo cats)
            scale: 2, // High resolution
        })
            .then((canvas) => {
                // 3. Trigger Download
                const link = document.createElement('a');
                link.download = 'my-polaroid-collage.png';
                link.href = canvas.toDataURL();
                link.click();

                // 4. Restore UI
                cameraZone.style.display = 'flex';
                btnContainer.style.display = 'flex';
            })
            .catch((err) => {
                console.error('Screenshot failed', err);
                alert(
                    'Could not download image. Security restrictions on images might be preventing it.'
                );
                // Restore UI in case of error
                cameraZone.style.display = 'flex';
                btnContainer.style.display = 'flex';
            });
    });

    shutter.addEventListener('click', (e) => {
        e.preventDefault();

        if (!demosCleared) {
            clearDemos();
            demosCleared = true;
        }

        flash.classList.add('flash-active');
        setTimeout(() => flash.classList.remove('flash-active'), 100);

        printSound.currentTime = 0;
        printSound.play().catch((e) => {
        });

        const ctx = canvas.getContext('2d');
        const size = Math.min(video.videoWidth, video.videoHeight);
        canvas.width = 400;
        canvas.height = 400;
        ctx.translate(400, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(
            video,
            (video.videoWidth - size) / 2,
            (video.videoHeight - size) / 2,
            size,
            size,
            0,
            0,
            400,
            400
        );

        ejectPhoto(canvas.toDataURL('image/jpeg'));
    });

    function ejectPhoto(src) {
        if (slot.firstChild) slot.removeChild(slot.firstChild);
        const p = createPolaroidElement(
            src,
            getTodayDateString(),
            null,
            null,
            null,
            false,
            true
        );
        p.classList.add('ejecting');
        slot.appendChild(p);
    }

    // Delete function
    function deletePolaroid(polaroidElement) {
        polaroidElement.style.opacity = '0';
        polaroidElement.style.transform = 'scale(0.8)';
        setTimeout(() => {
            polaroidElement.remove();
        }, 300);
    }

    // Zoom function
    function zoomPolaroid(polaroidElement, scale) {
        const currentTransform = polaroidElement.style.transform;
        const currentScaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
        const currentScale = currentScaleMatch ? parseFloat(currentScaleMatch[1]) : 1;
        const newScale = Math.max(0.5, Math.min(2.0, currentScale * scale)); // Limit between 0.5x and 2.0x

        polaroidElement.style.transition = 'transform 0.3s ease';
        polaroidElement.style.transform = currentTransform.replace(/scale\([^)]+\)/, `scale(${newScale})`) || `scale(${newScale})`;

        setTimeout(() => {
            polaroidElement.style.transition = '';
        }, 300);
    }

    function makeDraggable(elm) {
        let startX = 0,
            startY = 0,
            initialLeft = 0,
            initialTop = 0;

        elm.addEventListener('mousedown', dragStart);
        elm.addEventListener('touchstart', dragStart, {passive: false});

        function dragStart(e) {
            // Don't drag if clicking/tapping caption or share button
            if (e.target.closest('.caption-main') || e.target.closest('.polaroid-share-btn')) {
                return;
            }

            e.preventDefault();

            if (elm.classList.contains('developing-slow')) {
                elm.classList.remove('developing-slow');
                void elm.offsetWidth;
                elm.classList.add('developing-fast');
            }

            if (elm.classList.contains('ejecting')) {
                const rect = elm.getBoundingClientRect();
                elm.classList.remove('ejecting');
                document.body.appendChild(elm);
                elm.style.position = 'absolute';
                elm.style.left = rect.left + 'px';
                elm.style.top = rect.top + 'px';
                elm.style.transform = 'rotate(0deg)';
            } else if (elm.parentNode !== document.body) {
                const rect = elm.getBoundingClientRect();
                document.body.appendChild(elm);
                elm.style.left = rect.left + 'px';
                elm.style.top = rect.top + 'px';
            }

            elm.style.zIndex = 10000;

            if (e.type === 'touchstart') {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }

            initialLeft = elm.offsetLeft;
            initialTop = elm.offsetTop;

            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', dragMove, {passive: false});
        }

        function dragMove(e) {
            e.preventDefault();
            let currentX, currentY;

            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            } else {
                currentX = e.clientX;
                currentY = e.clientY;
            }

            const dx = currentX - startX;
            const dy = currentY - startY;

            elm.style.left = initialLeft + dx + 'px';
            elm.style.top = initialTop + dy + 'px';

            const tilt = Math.max(-8, Math.min(8, dx * 0.1));
            elm.style.transform = `rotate(${tilt}deg) scale(1.05)`;
        }

        function dragEnd() {
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('touchmove', dragMove);

            // Enable share button now that the polaroid has been placed on the desk
            elm.classList.add('can-share');

            elm.style.zIndex = 'auto';
            const finalRot = (Math.random() * 20 - 10).toFixed(1);
            elm.style.transition = 'transform 0.2s, box-shadow 0.2s';
            elm.style.transform = `rotate(${finalRot}deg) scale(1)`;
            setTimeout(() => {
                elm.style.transition = '';
            }, 200);
        }
    }
</script>

<!-- Footer Declaration -->
<div class="footer-declaration">

</div>
</body>
</html>
