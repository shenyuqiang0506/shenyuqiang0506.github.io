<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP 协议交互演示</title>
<!-- 引入 Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- 引入 Lucide 图标 -->
<script src="https://unpkg.com/lucide@latest"></script>
<style>
    /* 定义动画关键帧 */
    @keyframes slideRight {
    0% { left: 0%; transform: translate(0, -50%); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { left: 100%; transform: translate(-100%, -50%); opacity: 0; }
}
    @keyframes slideLeft {
    0% { left: 100%; transform: translate(-100%, -50%); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { left: 0%; transform: translate(0, -50%); opacity: 0; }
}

    @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

    .packet-wrapper {
    position: absolute;
    top: 50%;
    width: fit-content;
    /* 默认隐藏，动画开始时显示 */
    opacity: 0;
    z-index: 20;
}

    .animate-slide-right {
    animation: slideRight 1.5s linear forwards;
}

    .animate-slide-left {
    animation: slideLeft 1.5s linear forwards;
}

    .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
}

    /* 状态节点的动态样式类 */
    .node-closed { background-color: #94a3b8; border-color: #64748b; }
    .node-listen { background-color: #60a5fa; border-color: #3b82f6; } /* Default blueish */
    .node-syn-sent { background-color: #60a5fa; border-color: #3b82f6; }
    .node-established { background-color: #22c55e; border-color: #16a34a; } /* Green */
    .node-teardown { background-color: #f59e0b; border-color: #d97706; } /* Amber/Orange for intermediate states */
</style>
</head>
<body class="flex flex-col h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden">

<!-- Header -->
<header class="bg-white border-b border-slate-200 p-4 shadow-sm flex justify-between items-center z-10">
    <div class="flex items-center gap-2">
        <i data-lucide="activity" class="text-blue-600 w-6 h-6"></i>
        <h1 class="text-xl font-bold text-slate-800">TCP 协议交互演示</h1>
    </div>
    <div class="text-sm text-slate-500 hidden md:block">
        交互式可视化: 三次握手 & 四次挥手
    </div>
</header>

<!-- Main Visual Area -->
<main class="flex-1 relative flex items-center justify-center bg-slate-100 p-4 md:p-10 overflow-hidden">

    <!-- Connection Line (The "Network") -->
    <div class="absolute top-1/2 left-0 w-full h-2 bg-slate-300 transform -translate-y-1/2 z-0"></div>

    <div class="w-full max-w-5xl flex justify-between items-center relative z-10 h-64">

        <!-- Client Node -->
        <div class="flex flex-col items-center gap-4 w-40 md:w-48">
            <div id="client-node" class="w-24 h-24 md:w-32 md:h-32 rounded-2xl shadow-xl flex items-center justify-center transition-all duration-500 border-4 bg-slate-400 border-slate-500">
                <span class="text-white font-bold text-lg md:text-xl">客户端</span>
            </div>
            <div class="bg-white px-4 py-2 rounded-lg shadow-md border border-slate-200 text-center w-full">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider">State</div>
                <div id="client-state-text" class="font-mono font-bold text-blue-600">CLOSED</div>
            </div>
        </div>

        <!-- Packet Animation Area (Middle) -->
        <div id="packet-container" class="flex-1 h-full relative mx-4">
            <!-- Packets will be injected here by JS -->
        </div>

        <!-- Server Node -->
        <div class="flex flex-col items-center gap-4 w-40 md:w-48">
            <div id="server-node" class="w-24 h-24 md:w-32 md:h-32 rounded-2xl shadow-xl flex items-center justify-center transition-all duration-500 border-4 bg-green-400 border-green-500">
                <span class="text-white font-bold text-lg md:text-xl">服务端</span>
            </div>
            <div class="bg-white px-4 py-2 rounded-lg shadow-md border border-slate-200 text-center w-full">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider">State</div>
                <div id="server-state-text" class="font-mono font-bold text-blue-600">LISTEN</div>
            </div>
        </div>

    </div>
</main>

<!-- Control Panel -->
<div class="bg-white border-t border-slate-200 p-4 md:p-6 z-20">
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-6">

        <!-- Buttons -->
        <div class="flex flex-wrap gap-3 items-start md:w-1/3">
            <button id="btn-handshake" onclick="startHandshake()" class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all bg-blue-600 text-white hover:bg-blue-700 hover:shadow-md disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed">
                <i data-lucide="shield-check" class="w-4 h-4"></i>
                建立连接 (三次握手)
            </button>

            <button id="btn-send-data" onclick="sendData()" disabled class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="send" class="w-4 h-4"></i>
                发送数据
            </button>

            <button id="btn-teardown" onclick="startTeardown()" disabled class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="x-circle" class="w-4 h-4"></i>
                断开连接 (四次挥手)
            </button>

            <button onclick="resetApp()" class="flex items-center gap-2 px-4 py-3 rounded-lg font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all ml-auto md:ml-0">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                重置
            </button>
        </div>

        <!-- Logs -->
        <div class="flex-1 bg-slate-900 rounded-lg p-4 font-mono text-sm h-48 overflow-y-auto shadow-inner border border-slate-700 relative" id="log-container">
            <div class="text-slate-400 mb-2 text-xs border-b border-slate-700 pb-1 sticky top-0 bg-slate-900">System Log</div>
            <div id="logs-content" class="flex flex-col gap-1">
                <span class="text-slate-600 italic">等待操作...</span>
            </div>
        </div>

    </div>
</div>

<script>
    // 初始化图标
    lucide.createIcons();

    // --- 状态变量 ---
    let connectionStatus = 'CLOSED'; // CLOSED, HANDSHAKING, ESTABLISHED, TEARING_DOWN
    let clientState = 'CLOSED';
    let serverState = 'LISTEN';
    let seq = 100;
    let ack = 0;

    // --- DOM 元素引用 ---
    const clientNode = document.getElementById('client-node');
    const serverNode = document.getElementById('server-node');
    const clientStateText = document.getElementById('client-state-text');
    const serverStateText = document.getElementById('server-state-text');
    const packetContainer = document.getElementById('packet-container');
    const logsContent = document.getElementById('logs-content');
    const logContainer = document.getElementById('log-container');

    const btnHandshake = document.getElementById('btn-handshake');
    const btnSendData = document.getElementById('btn-send-data');
    const btnTeardown = document.getElementById('btn-teardown');

    // --- 辅助函数 ---

    function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

    function updateUI() {
    // 更新状态文本
    clientStateText.innerText = clientState;
    serverStateText.innerText = serverState;

    // 更新颜色样式 - Client
    updateNodeStyle(clientNode, clientStateText, clientState);
    // 更新颜色样式 - Server
    updateNodeStyle(serverNode, serverStateText, serverState);

    // 更新按钮状态
    if (connectionStatus === 'CLOSED') {
    enableBtn(btnHandshake, 'bg-blue-600', 'hover:bg-blue-700', 'text-white');
    disableBtn(btnSendData);
    disableBtn(btnTeardown);
} else if (connectionStatus === 'ESTABLISHED') {
    disableBtn(btnHandshake);
    enableBtn(btnSendData, 'bg-green-600', 'hover:bg-green-700', 'text-white');
    enableBtn(btnTeardown, 'bg-red-500', 'hover:bg-red-600', 'text-white');
} else {
    // Handshaking or Tearing down - disable all
    disableBtn(btnHandshake);
    disableBtn(btnSendData);
    disableBtn(btnTeardown);
}
}

    function updateNodeStyle(node, textNode, state) {
    // Reset base classes
    node.className = "w-24 h-24 md:w-32 md:h-32 rounded-2xl shadow-xl flex items-center justify-center transition-all duration-500 border-4";
    textNode.className = "font-mono font-bold";

    if (state === 'ESTABLISHED') {
    node.classList.add('bg-green-500', 'border-green-600');
    textNode.classList.add('text-green-600');
} else if (state === 'CLOSED') {
    node.classList.add('bg-slate-400', 'border-slate-500');
    textNode.classList.add('text-slate-500');
} else {
    // Intermediate states (SYN_SENT, LISTENING, etc.)
    node.classList.add('bg-blue-400', 'border-blue-500');
    textNode.classList.add('text-blue-600');
}
}

    function enableBtn(btn, ...classes) {
    btn.disabled = false;
    btn.className = `flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all hover:shadow-md ${classes.join(' ')}`;
}

    function disableBtn(btn) {
    btn.disabled = true;
    btn.className = `flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all bg-slate-200 text-slate-400 cursor-not-allowed`;
}

    function addLog(message, type = 'info') {
    // 如果是第一条日志，清空初始提示
    if (logsContent.children.length === 1 && logsContent.children[0].tagName === 'SPAN') {
    logsContent.innerHTML = '';
}

    const timestamp = new Date().toLocaleTimeString();
    const logItem = document.createElement('div');
    logItem.className = 'animate-fade-in';

    let colorClass = 'text-blue-300';
    if (type === 'system') colorClass = 'text-yellow-400 font-bold';
    if (type === 'success') colorClass = 'text-green-400';
    if (type === 'error') colorClass = 'text-red-400';

    logItem.innerHTML = `<span class="text-slate-500 text-xs mr-2">[${timestamp}]</span><span class="${colorClass}">${message}</span>`;

    logsContent.appendChild(logItem);

    // 自动滚动到底部
    logContainer.scrollTop = logContainer.scrollHeight;
}

    async function sendPacket(from, type, flags, content = '') {
    const direction = from === 'client' ? 'left-to-right' : 'right-to-left';
    const animationClass = direction === 'left-to-right' ? 'animate-slide-right' : 'animate-slide-left';

    // 创建 Packet 元素
    const pkt = document.createElement('div');
    pkt.className = `packet-wrapper ${animationClass}`;

    // 构建 Packet 内部 HTML
    let flagsHtml = '';
    if (flags.syn) flagsHtml += `<span class="bg-black text-white px-1 rounded">SYN</span>`;
    if (flags.ack) flagsHtml += `<span class="bg-black text-white px-1 rounded">ACK</span>`;
    if (flags.fin) flagsHtml += `<span class="bg-red-600 text-white px-1 rounded">FIN</span>`;

    let contentHtml = '';
    if (content) {
    contentHtml = `<div class="mt-1 text-xs text-slate-700 bg-yellow-200 px-1 rounded w-full text-center truncate">${content}</div>`;
}

    pkt.innerHTML = `
                <div class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded shadow-lg border-2 border-yellow-500 flex flex-col items-center min-w-[120px]">
                    <div class="font-bold text-sm">${type}</div>
                    <div class="flex gap-1 mt-1 text-[10px] uppercase">
                        ${flagsHtml}
                    </div>
                    ${contentHtml}
                </div>
            `;

    packetContainer.appendChild(pkt);

    // 等待动画结束 (1.5s)
    await delay(1500);

    // 移除元素
    if (packetContainer.contains(pkt)) {
    packetContainer.removeChild(pkt);
}
}

    // --- 核心业务逻辑 ---

    async function startHandshake() {
    if (connectionStatus !== 'CLOSED') return;

    connectionStatus = 'HANDSHAKING';
    updateUI();

    logsContent.innerHTML = ''; // 清空日志
    addLog('开始 TCP 三次握手...', 'system');

    // Step 1
    clientState = 'SYN_SENT';
    updateUI();
    addLog('客户端: 发送 SYN 包 (Seq=0). 进入 SYN_SENT 状态。');
    await sendPacket('client', 'SYN', { syn: true, ack: false, fin: false });

    // Step 2
    serverState = 'SYN_RCVD';
    updateUI();
    addLog('服务端: 收到 SYN. 发送 SYN-ACK (Seq=0, Ack=1). 进入 SYN_RCVD 状态。');
    await sendPacket('server', 'SYN-ACK', { syn: true, ack: true, fin: false });

    // Step 3
    clientState = 'ESTABLISHED';
    updateUI();
    addLog('客户端: 收到 SYN-ACK. 发送 ACK (Seq=1, Ack=1). 连接已建立 (ESTABLISHED)。', 'success');
    await sendPacket('client', 'ACK', { syn: false, ack: true, fin: false });

    // Finish
    serverState = 'ESTABLISHED';
    connectionStatus = 'ESTABLISHED';
    seq = 1;
    ack = 1;
    updateUI();
    addLog('服务端: 收到 ACK. 连接已建立 (ESTABLISHED)。', 'success');
}

    async function sendData() {
    if (connectionStatus !== 'ESTABLISHED') return;

    const currentSeq = seq;
    const dataSize = Math.floor(Math.random() * 100) + 50;

    addLog(`客户端: 发送数据长度 ${dataSize} (Seq=${currentSeq}, Ack=${ack}).`);
    await sendPacket('client', 'PSH', { syn: false, ack: true, fin: false }, `Data: ${dataSize}B`);

    addLog(`服务端: 收到数据. 发送确认 ACK (Ack=${currentSeq + dataSize}).`);
    await sendPacket('server', 'ACK', { syn: false, ack: true, fin: false });

    seq += dataSize;
    addLog(`客户端: 收到确认.`, 'success');
}

    async function startTeardown() {
    if (connectionStatus !== 'ESTABLISHED') return;

    connectionStatus = 'TEARING_DOWN';
    updateUI();
    addLog('开始 TCP 四次挥手断开连接...', 'system');

    // Step 1
    clientState = 'FIN_WAIT_1';
    updateUI();
    addLog('客户端: 发送 FIN 包. 进入 FIN_WAIT_1 状态。');
    await sendPacket('client', 'FIN', { syn: false, ack: true, fin: true });

    // Step 2
    serverState = 'CLOSE_WAIT';
    updateUI();
    addLog('服务端: 收到 FIN. 发送 ACK. 进入 CLOSE_WAIT 状态。');
    await sendPacket('server', 'ACK', { syn: false, ack: true, fin: false });

    clientState = 'FIN_WAIT_2';
    updateUI();
    addLog('客户端: 收到 ACK. 进入 FIN_WAIT_2 状态。等待服务端关闭。');

    // Simulate server processing time
    await delay(800);
    addLog('服务端: 准备关闭完成。');

    // Step 3
    serverState = 'LAST_ACK';
    updateUI();
    addLog('服务端: 发送 FIN 包. 进入 LAST_ACK 状态。');
    await sendPacket('server', 'FIN', { syn: false, ack: true, fin: true });

    // Step 4
    clientState = 'TIME_WAIT';
    updateUI();
    addLog('客户端: 收到 FIN. 发送 ACK. 进入 TIME_WAIT 状态。');
    await sendPacket('client', 'ACK', { syn: false, ack: true, fin: false });

    serverState = 'CLOSED';
    updateUI();
    addLog('服务端: 收到 ACK. 连接关闭 (CLOSED)。', 'error');

    // Simulate TIME_WAIT timeout
    addLog('客户端: 等待 2MSL 以确保服务端收到 ACK...');
    await delay(1500);
    clientState = 'CLOSED';
    connectionStatus = 'CLOSED';

    // Reset Server to LISTEN automatically for demo purposes, or keep CLOSED?
    // Usually server goes back to LISTEN if it's a daemon, but for this specific connection it is closed.
    // Let's reset server to LISTEN to allow restart.
    serverState = 'LISTEN';

    updateUI();
    addLog('客户端: 超时结束. 连接关闭 (CLOSED)。', 'error');
}

    function resetApp() {
    connectionStatus = 'CLOSED';
    clientState = 'CLOSED';
    serverState = 'LISTEN';
    seq = 100;
    ack = 0;
    logsContent.innerHTML = '<span class="text-slate-600 italic">等待操作...</span>';
    packetContainer.innerHTML = ''; // 清除所有正在飞行的包
    updateUI();
}

    // 初始化 UI
    updateUI();

</script>
</body>
</html>