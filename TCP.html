<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TCP 协议交互演示：）</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide 图标 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- 桌面端动画 (左右移动) --- */
        @keyframes slideRight {
            0% { left: 0%; transform: translate(0, -50%); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 100%; transform: translate(-100%, -50%); opacity: 0; }
        }
        @keyframes slideLeft {
            0% { left: 100%; transform: translate(-100%, -50%); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 0%; transform: translate(0, -50%); opacity: 0; }
        }

        /* --- 手机端动画 (上下移动) --- */
        @keyframes slideDown {
            0% { top: 0%; transform: translate(-50%, 0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; transform: translate(-50%, -100%); opacity: 0; }
        }
        @keyframes slideUp {
            0% { top: 100%; transform: translate(-50%, -100%); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 0%; transform: translate(-50%, 0); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .packet-wrapper {
            position: absolute;
            width: fit-content;
            opacity: 0;
            z-index: 20;
        }

        /* 默认手机端样式 (垂直) */
        .animate-c2s { /* Client to Server (Down) */
            left: 50%;
            animation: slideDown 1.5s linear forwards;
        }
        .animate-s2c { /* Server to Client (Up) */
            left: 50%;
            animation: slideUp 1.5s linear forwards;
        }

        /* 桌面端样式 (水平) - 覆盖手机端 */
        @media (min-width: 768px) {
            .animate-c2s {
                left: auto; /* 重置 */
                top: 50%;
                animation: slideRight 1.5s linear forwards;
            }
            .animate-s2c {
                left: auto; /* 重置 */
                top: 50%;
                animation: slideLeft 1.5s linear forwards;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* 状态节点的动态样式类 */
        .node-closed { background-color: #94a3b8; border-color: #64748b; }
        .node-listen { background-color: #60a5fa; border-color: #3b82f6; }
        .node-established { background-color: #22c55e; border-color: #16a34a; }
    </style>
</head>
<!-- 修改：使用 fixed inset-0 锁定视口，防止移动端滚动穿透或顶起 -->
<body class="fixed inset-0 flex flex-col bg-slate-50 text-slate-800 font-sans overflow-hidden">

<!-- Header -->
<header class="bg-white border-b border-slate-200 p-3 md:p-4 shadow-sm flex justify-between items-center z-30 flex-shrink-0">
    <div class="flex items-center gap-2">
        <i data-lucide="activity" class="text-blue-600 w-5 h-5 md:w-6 md:h-6"></i>
        <h1 class="text-lg md:text-xl font-bold text-slate-800">TCP 协议演示</h1>
    </div>
    <div class="text-xs md:text-sm text-slate-500">
        可视化交互
    </div>
</header>

<!-- Main Visual Area -->
<!-- 修改：增加 min-h-0 确保在 Flex 布局中可以正确收缩，不会被撑开 -->
<main class="flex-1 relative flex items-center justify-center bg-slate-100 p-2 md:p-10 overflow-hidden min-h-0">

    <!-- Connection Line (The "Network") -->
    <!-- 手机: 垂直线, 桌面: 水平线 -->
    <div class="absolute bg-slate-300 z-0
                    left-1/2 top-0 h-full w-2 transform -translate-x-1/2
                    md:top-1/2 md:left-0 md:w-full md:h-2 md:translate-x-0 md:-translate-y-1/2">
    </div>

    <!-- 布局容器: 手机 flex-col (上下), 桌面 flex-row (左右) -->
    <div class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-center relative z-10 h-full md:h-64 py-4 md:py-0">

        <!-- Client Node -->
        <div class="flex flex-row md:flex-col items-center gap-2 md:gap-4 w-full md:w-auto px-4 md:px-0 z-10">
            <div id="client-node" class="w-16 h-16 md:w-32 md:h-32 rounded-xl md:rounded-2xl shadow-xl flex items-center justify-center transition-all duration-500 border-4 bg-slate-400 border-slate-500 shrink-0">
                <span class="text-white font-bold text-sm md:text-xl">Client</span>
            </div>
            <div class="bg-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg shadow-md border border-slate-200 text-center w-full md:w-48">
                <div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider">State</div>
                <div id="client-state-text" class="font-mono font-bold text-sm md:text-base text-blue-600">CLOSED</div>
            </div>
        </div>

        <!-- Packet Animation Area (Middle) -->
        <!-- 手机: flex-1 w-full (垂直空间), 桌面: flex-1 h-full (水平空间) -->
        <div id="packet-container" class="flex-1 w-full md:h-full relative my-2 md:my-0 md:mx-4">
            <!-- Packets will be injected here by JS -->
        </div>

        <!-- Server Node -->
        <div class="flex flex-row-reverse md:flex-col items-center gap-2 md:gap-4 w-full md:w-auto px-4 md:px-0 z-10">
            <div id="server-node" class="w-16 h-16 md:w-32 md:h-32 rounded-xl md:rounded-2xl shadow-xl flex items-center justify-center transition-all duration-500 border-4 bg-green-400 border-green-500 shrink-0">
                <span class="text-white font-bold text-sm md:text-xl">Server</span>
            </div>
            <div class="bg-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg shadow-md border border-slate-200 text-center w-full md:w-48">
                <div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider">State</div>
                <div id="server-state-text" class="font-mono font-bold text-sm md:text-base text-blue-600">LISTEN</div>
            </div>
        </div>

    </div>
</main>

<!-- Control Panel -->
<div class="bg-white border-t border-slate-200 p-3 md:p-6 z-30 flex-shrink-0 safe-pb">
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-4 md:gap-6">

        <!-- Buttons -->
        <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3 items-start md:w-1/3">
            <button id="btn-handshake" onclick="startHandshake()" class="col-span-2 md:col-span-1 flex justify-center items-center gap-2 px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold shadow-sm transition-all text-sm md:text-base bg-blue-600 text-white hover:bg-blue-700 disabled:bg-slate-200 disabled:text-slate-400">
                <i data-lucide="shield-check" class="w-4 h-4"></i>
                建立连接
            </button>

            <button id="btn-send-data" onclick="sendData()" disabled class="flex justify-center items-center gap-2 px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold shadow-sm transition-all text-sm md:text-base bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="send" class="w-4 h-4"></i>
                发送数据
            </button>

            <button id="btn-teardown" onclick="startTeardown()" disabled class="flex justify-center items-center gap-2 px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold shadow-sm transition-all text-sm md:text-base bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="x-circle" class="w-4 h-4"></i>
                断开连接
            </button>

            <button onclick="resetApp()" class="col-span-2 md:col-span-1 flex justify-center items-center gap-2 px-3 py-2 md:px-4 md:py-3 rounded-lg font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all text-sm md:text-base md:ml-auto">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                重置
            </button>
        </div>

        <!-- Logs -->
        <!-- 修改：移除 flex-1 以避免在手机端垂直方向撑满剩余空间，改为固定高度并 shrink-0 -->
        <!-- 在桌面端 (md) 恢复 flex-1 以占据横向剩余空间 -->
        <div class="w-full h-32 md:h-48 md:flex-1 shrink-0 bg-slate-900 rounded-lg p-3 font-mono text-xs md:text-sm overflow-y-auto shadow-inner border border-slate-700 relative" id="log-container">
            <div class="text-slate-400 mb-2 text-[10px] md:text-xs border-b border-slate-700 pb-1 sticky top-0 bg-slate-900">System Log</div>
            <div id="logs-content" class="flex flex-col gap-1">
                <span class="text-slate-600 italic">等待操作...</span>
            </div>
        </div>

    </div>
</div>

<script>
    lucide.createIcons();

    // --- 状态变量 ---
    let connectionStatus = 'CLOSED';
    let clientState = 'CLOSED';
    let serverState = 'LISTEN';
    let seq = 100;
    let ack = 0;

    // --- DOM ---
    const clientNode = document.getElementById('client-node');
    const serverNode = document.getElementById('server-node');
    const clientStateText = document.getElementById('client-state-text');
    const serverStateText = document.getElementById('server-state-text');
    const packetContainer = document.getElementById('packet-container');
    const logsContent = document.getElementById('logs-content');
    const logContainer = document.getElementById('log-container');

    const btnHandshake = document.getElementById('btn-handshake');
    const btnSendData = document.getElementById('btn-send-data');
    const btnTeardown = document.getElementById('btn-teardown');

    // --- 辅助 ---
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateUI() {
        clientStateText.innerText = clientState;
        serverStateText.innerText = serverState;
        updateNodeStyle(clientNode, clientStateText, clientState);
        updateNodeStyle(serverNode, serverStateText, serverState);

        if (connectionStatus === 'CLOSED') {
            enableBtn(btnHandshake, 'bg-blue-600', 'hover:bg-blue-700', 'text-white');
            disableBtn(btnSendData);
            disableBtn(btnTeardown);
        } else if (connectionStatus === 'ESTABLISHED') {
            disableBtn(btnHandshake);
            enableBtn(btnSendData, 'bg-green-600', 'hover:bg-green-700', 'text-white');
            enableBtn(btnTeardown, 'bg-red-500', 'hover:bg-red-600', 'text-white');
        } else {
            disableBtn(btnHandshake);
            disableBtn(btnSendData);
            disableBtn(btnTeardown);
        }
    }

    function updateNodeStyle(node, textNode, state) {
        // 保留基础样式，只修改颜色
        const baseClasses = node.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('border-') && !c.startsWith('text-')).join(' ');

        // 重新设置颜色
        if (state === 'ESTABLISHED') {
            node.className = `${baseClasses} bg-green-500 border-green-600`;
            textNode.className = "font-mono font-bold text-green-600 text-sm md:text-base";
        } else if (state === 'CLOSED') {
            node.className = `${baseClasses} bg-slate-400 border-slate-500`;
            textNode.className = "font-mono font-bold text-slate-500 text-sm md:text-base";
        } else {
            node.className = `${baseClasses} bg-blue-400 border-blue-500`;
            textNode.className = "font-mono font-bold text-blue-600 text-sm md:text-base";
        }
    }

    function enableBtn(btn, ...classes) {
        btn.disabled = false;
        // 保持基础布局类，更新颜色类
        const base = "flex justify-center items-center gap-2 px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold shadow-sm transition-all text-sm md:text-base hover:shadow-md";
        // 处理 Grid 特例
        const gridClass = btn.id === 'btn-handshake' ? 'col-span-2 md:col-span-1' : '';
        btn.className = `${gridClass} ${base} ${classes.join(' ')}`;
    }

    function disableBtn(btn) {
        btn.disabled = true;
        const base = "flex justify-center items-center gap-2 px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold shadow-sm transition-all text-sm md:text-base bg-slate-200 text-slate-400 cursor-not-allowed";
        // 处理 Grid 特例
        const gridClass = btn.id === 'btn-handshake' ? 'col-span-2 md:col-span-1' : '';
        btn.className = `${gridClass} ${base}`;
    }

    function addLog(message, type = 'info') {
        if (logsContent.children.length === 1 && logsContent.children[0].tagName === 'SPAN') {
            logsContent.innerHTML = '';
        }
        const timestamp = new Date().toLocaleTimeString();
        const logItem = document.createElement('div');
        logItem.className = 'animate-fade-in';

        let colorClass = 'text-blue-500 md:text-blue-300';
        if (type === 'system') colorClass = 'text-yellow-600 md:text-yellow-400 font-bold';
        if (type === 'success') colorClass = 'text-green-600 md:text-green-400';
        if (type === 'error') colorClass = 'text-red-500 md:text-red-400';

        logItem.innerHTML = `<span class="text-slate-400 text-[10px] mr-2">[${timestamp}]</span><span class="${colorClass}">${message}</span>`;
        logsContent.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    async function sendPacket(from, type, flags, content = '') {
        // 使用通用的方向类名：c2s (Client to Server), s2c (Server to Client)
        // CSS 中会根据屏幕宽度决定是 水平移动 还是 垂直移动
        const animClass = from === 'client' ? 'animate-c2s' : 'animate-s2c';

        const pkt = document.createElement('div');
        pkt.className = `packet-wrapper ${animClass}`;

        let flagsHtml = '';
        if (flags.syn) flagsHtml += `<span class="bg-black text-white px-1 rounded">SYN</span>`;
        if (flags.ack) flagsHtml += `<span class="bg-black text-white px-1 rounded">ACK</span>`;
        if (flags.fin) flagsHtml += `<span class="bg-red-600 text-white px-1 rounded">FIN</span>`;

        let contentHtml = '';
        if (content) {
            contentHtml = `<div class="mt-1 text-[10px] text-slate-700 bg-yellow-200 px-1 rounded w-full text-center truncate max-w-[100px]">${content}</div>`;
        }

        pkt.innerHTML = `
                <div class="bg-yellow-400 text-yellow-900 px-3 py-1.5 md:px-4 md:py-2 rounded shadow-lg border-2 border-yellow-500 flex flex-col items-center min-w-[100px] md:min-w-[120px] scale-90 md:scale-100 origin-center">
                    <div class="font-bold text-xs md:text-sm">${type}</div>
                    <div class="flex gap-1 mt-0.5 md:mt-1 text-[8px] md:text-[10px] uppercase">
                        ${flagsHtml}
                    </div>
                    ${contentHtml}
                </div>
            `;

        packetContainer.appendChild(pkt);
        await delay(1500);
        if (packetContainer.contains(pkt)) packetContainer.removeChild(pkt);
    }

    // --- 逻辑 (保持不变) ---
    async function startHandshake() {
        if (connectionStatus !== 'CLOSED') return;
        connectionStatus = 'HANDSHAKING';
        updateUI();
        logsContent.innerHTML = '';
        addLog('开始三次握手...', 'system');

        clientState = 'SYN_SENT';
        updateUI();
        addLog('Client: 发送 SYN (Seq=0)');
        await sendPacket('client', 'SYN', { syn: true, ack: false, fin: false });

        serverState = 'SYN_RCVD';
        updateUI();
        addLog('Server: 收到 SYN, 发送 SYN-ACK (Ack=1)');
        await sendPacket('server', 'SYN-ACK', { syn: true, ack: true, fin: false });

        clientState = 'ESTABLISHED';
        updateUI();
        addLog('Client: 收到, 发送 ACK. 连接建立!', 'success');
        await sendPacket('client', 'ACK', { syn: false, ack: true, fin: false });

        serverState = 'ESTABLISHED';
        connectionStatus = 'ESTABLISHED';
        seq = 1; ack = 1;
        updateUI();
        addLog('Server: 收到 ACK. 连接建立!', 'success');
    }

    async function sendData() {
        if (connectionStatus !== 'ESTABLISHED') return;
        const currentSeq = seq;
        const dataSize = Math.floor(Math.random() * 50) + 20;

        addLog(`Client: 发送数据 ${dataSize}B (Seq=${currentSeq})`);
        await sendPacket('client', 'PSH', { syn: false, ack: true, fin: false }, `Data: ${dataSize}B`);

        addLog(`Server: 收到数据, 发送 ACK (Ack=${currentSeq + dataSize})`);
        await sendPacket('server', 'ACK', { syn: false, ack: true, fin: false });

        seq += dataSize;
        addLog(`Client: 收到确认`, 'success');
    }

    async function startTeardown() {
        if (connectionStatus !== 'ESTABLISHED') return;
        connectionStatus = 'TEARING_DOWN';
        updateUI();
        addLog('开始四次挥手...', 'system');

        clientState = 'FIN_WAIT_1';
        updateUI();
        addLog('Client: 发送 FIN');
        await sendPacket('client', 'FIN', { syn: false, ack: true, fin: true });

        serverState = 'CLOSE_WAIT';
        updateUI();
        addLog('Server: 收到 FIN, 发送 ACK');
        await sendPacket('server', 'ACK', { syn: false, ack: true, fin: false });

        clientState = 'FIN_WAIT_2';
        updateUI();
        addLog('Client: 等待 Server 关闭...');
        await delay(800);
        addLog('Server: 准备关闭完成');

        serverState = 'LAST_ACK';
        updateUI();
        addLog('Server: 发送 FIN');
        await sendPacket('server', 'FIN', { syn: false, ack: true, fin: true });

        clientState = 'TIME_WAIT';
        updateUI();
        addLog('Client: 发送 ACK, 进入 TIME_WAIT');
        await sendPacket('client', 'ACK', { syn: false, ack: true, fin: false });

        serverState = 'CLOSED';
        updateUI();
        addLog('Server: 连接关闭', 'error');

        addLog('Client: 等待 2MSL...');
        await delay(1500);
        clientState = 'CLOSED';
        connectionStatus = 'CLOSED';
        serverState = 'LISTEN';
        updateUI();
        addLog('Client: 超时结束, 连接关闭', 'error');
    }

    function resetApp() {
        connectionStatus = 'CLOSED';
        clientState = 'CLOSED';
        serverState = 'LISTEN';
        seq = 100; ack = 0;
        logsContent.innerHTML = '<span class="text-slate-600 italic">等待操作...</span>';
        packetContainer.innerHTML = '';
        updateUI();
    }

    updateUI();
</script>
</body>
</html>